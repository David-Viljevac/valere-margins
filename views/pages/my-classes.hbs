{{#if error}}
    <div style="background-color: #e74c3c; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        {{error}}
    </div>
{{/if}}

{{#if success}}
    <div style="background-color: #27ae60; color: white; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
        {{success}}
    </div>
{{/if}}

<div class="page-header" style="margin-bottom: 30px;">
    <h1 style="color: #2c3e50; margin-bottom: 10px;">My Classes</h1>
    <p style="color: #7f8c8d;">View and manage your enrolled classes</p>
</div>

<!-- Classes Statistics -->
<div class="dashboard-stats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div style="background: white; padding: 20px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="color: #2c3e50;">Enrolled Classes</h3>
        <p style="font-size: 2em; color: #3498db;">{{myClasses.length}}</p>
    </div>
</div>

<!-- My Classes List -->
{{#if myClasses.length}}
    <div class="classes-section">
        <h2 style="color: #2c3e50; margin-bottom: 20px;">Your Enrolled Classes</h2>
        
        <div class="classes-grid" id="myClassesGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 20px;">
            {{#each myClasses}}
                <div style="background: white; padding: 25px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid {{#if class.is_active}}#27ae60{{else}}#e74c3c{{/if}};" id="class-enrollment-{{user_id}}-{{class_id}}">
                    <!-- Class Header -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h3 style="color: #2c3e50; margin-bottom: 8px;">
                                {{sport_name}} - {{description}}
                            </h3>
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <span style="background: {{#if is_active}}#27ae60{{else}}#e74c3c{{/if}}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">
                                    {{#if is_active}}Active{{else}}Inactive{{/if}}
                                </span>
                                <span style="color: #7f8c8d; font-size: 14px;">
                                    {{start_time}} - {{end_time}}
                                </span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <span style="color: #3498db; font-size: 12px; font-weight: bold;">Joined:</span>
                                <span style="color: #7f8c8d; font-size: 12px;">{{joined_at}}</span>
                            </div>
                        </div>
                        
                        <!-- Leave Button -->
                        <div style="flex-shrink: 0;">
                            <button 
                                onclick="leaveClass('{{id}}', '{{sport_name}} - {{description}}')"
                                style="padding: 8px 12px; background-color: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 12px; transition: background-color 0.3s;"
                                onmouseover="this.style.backgroundColor='#c0392b'"
                                onmouseout="this.style.backgroundColor='#e74c3c'"
                                title="Leave Class"
                            >
                                Leave Class
                            </button>
                        </div>
                    </div>
                    
                    <!-- Class Details -->
                    <div style="margin-bottom: 15px;">
                        <div style="margin-bottom: 8px;">
                            <strong style="color: #2c3e50; font-size: 14px;">Active Days:</strong>
                            <div style="margin-top: 5px;">
                                {{#each active_days}}
                                    <span style="background: #ecf0f1; color: #2c3e50; padding: 2px 6px; border-radius: 3px; font-size: 11px; margin-right: 5px;">
                                        {{this}}
                                    </span>
                                {{/each}}
                            </div>
                        </div>
                        
                        {{#if allUsers.length}}
                            <div style="margin-top: 10px;">
                                <strong style="color: #2c3e50; font-size: 12px;">Other Students ({{allUsers.length}} total):</strong>
                                <div style="margin-top: 5px; max-height: 60px; overflow-y: auto;">
                                    {{#each allUsers}}
                                        <span style="display: inline-block; background: #3498db; color: white; padding: 2px 6px; border-radius: 3px; font-size: 10px; margin-right: 5px; margin-bottom: 3px;">
                                            {{first_name}} {{last_name}}
                                        </span>
                                    {{/each}}
                                </div>
                            </div>
                        {{/if}}
                    </div>
                </div>
            {{/each}}
        </div>
    </div>
{{else}}
    <div style="text-align: center; padding: 60px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <h2 style="color: #7f8c8d; margin-bottom: 15px;">No Classes Enrolled</h2>
        <p style="color: #95a5a6; margin-bottom: 20px;">You haven't enrolled in any classes yet. Browse available classes to get started!</p>
    </div>
{{/if}}

<!-- Confirmation Modal -->
<div id="confirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; min-width: 400px; max-width: 500px;">
        <h3 style="color: #2c3e50; margin-bottom: 20px;">Confirm Leave Class</h3>
        <p style="color: #7f8c8d; margin-bottom: 20px;" id="confirmMessage">
            Are you sure you want to leave this class?
        </p>
        
        <div style="display: flex; gap: 15px; justify-content: flex-end;">
            <button 
                type="button" 
                onclick="closeConfirmModal()"
                style="padding: 10px 20px; background-color: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;"
            >
                Cancel
            </button>
            <button 
                type="button" 
                onclick="confirmLeave()"
                style="padding: 10px 20px; background-color: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;"
                id="confirmLeaveButton"
            >
                Leave Class
            </button>
        </div>
    </div>
</div>

<script>
let currentClassId = null;
let currentClassName = null;

// Leave class functionality
function leaveClass(classId, className) {
    currentClassId = classId;
    currentClassName = className;
    
    document.getElementById('confirmMessage').textContent = `Are you sure you want to leave "${className}"? You can re-enroll later if the class is still available.`;
    document.getElementById('confirmModal').style.display = 'block';
}

function closeConfirmModal() {
    document.getElementById('confirmModal').style.display = 'none';
    currentClassId = null;
    currentClassName = null;
}

async function confirmLeave() {
    console.log(currentClassId)
    if (!currentClassId) return;
    
    try {
        const response = await fetch(`/classes/${currentClassId}/leave`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            credentials: 'include'
        });

        if (response.ok) {
            closeConfirmModal();
            showNotification(`Successfully left "${currentClassName}"`, 'success');
            
            // Refresh page after 1 second to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            const result = await response.json();
            throw new Error(result.message || 'Failed to leave class');
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Error leaving class: ' + error.message, 'error');
        closeConfirmModal();
    }
}

// Update enrollment count
function updateEnrollmentCount() {
    const enrollmentCards = document.querySelectorAll('#myClassesGrid > div');
    const count = enrollmentCards.length;
    
    // Update both enrolled and active counts
    const enrolledElement = document.querySelector('p[style*="color: #3498db"]');
    const activeElement = document.getElementById('activeEnrollmentsCount');
    
    if (enrolledElement) enrolledElement.textContent = count;
    if (activeElement) activeElement.textContent = count;
}

// Show no classes message
function showNoClassesMessage() {
    const classesSection = document.querySelector('.classes-section');
    if (classesSection) {
        classesSection.innerHTML = `
            <div style="text-align: center; padding: 60px; background: white; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h2 style="color: #7f8c8d; margin-bottom: 15px;">No Classes Enrolled</h2>
                <p style="color: #95a5a6; margin-bottom: 20px;">You haven't enrolled in any classes yet. Browse available classes to get started!</p>
                <div style="font-size: 48px; margin-bottom: 20px; color: #bdc3c7;">📚</div>
                <a href="/classes" style="display: inline-block; padding: 12px 25px; background-color: #3498db; color: white; text-decoration: none; border-radius: 5px; font-weight: bold;">
                    Browse Classes
                </a>
            </div>
        `;
    }
}

// Show notifications
function showNotification(message, type = 'info') {
    const existing = document.getElementById('notification');
    if (existing) existing.remove();

    const notification = document.createElement('div');
    notification.id = 'notification';
    notification.textContent = message;
    
    const colors = {
        success: '#27ae60',
        error: '#e74c3c',
        info: '#3498db'
    };
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${colors[type] || colors.info};
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 9999;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        max-width: 300px;
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Close modal when clicking outside
document.getElementById('confirmModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeConfirmModal();
    }
});
</script>